<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP CHAT - Powered by Julixixi</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #020617; --card: #0f172a; --text: #f8fafc; --input: #1e293b; --danger: #ef4444; }
        body.theme-lembut { --primary: #be185d; --bg: #fff1f2; --card: #ffffff; --text: #831843; --input: #fce7f3; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; align-items: center; overflow: hidden; position: fixed; width: 100%; }

        .container { width: 100%; max-width: 450px; height: 100%; background: var(--card); display: flex; flex-direction: column; position: relative; }
        @media (min-width: 600px) { .container { height: 92vh; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); } }

        /* VIDEO UI FIX */
        #video-grid { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 110px; height: 160px; border-radius: 12px; border: 2px solid var(--primary); object-fit: cover; background: #222; z-index: 10000; }
        .call-tools { position: absolute; bottom: 50px; left: 0; width: 100%; display: flex; justify-content: center; gap: 25px; z-index: 10001; }
        .btn-call-end { width: 65px; height: 65px; border-radius: 50%; background: var(--danger); border: none; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        /* FLOATING UI */
        .btn-float { position: fixed; width: 48px; height: 48px; border-radius: 14px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: #fff; }
        .btn-notif { top: 15px; right: 15px; }
        .btn-theme { top: 15px; left: 15px; }
        .btn-admin { bottom: 15px; left: 15px; }

        header { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 10px 14px; border-radius: 16px; max-width: 80%; font-size: 14px; }
        .msg.own { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: var(--input); border-bottom-left-radius: 2px; }

        .input-area { padding: 10px 15px 30px 15px; display: flex; gap: 10px; border-top: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; background: var(--card); }
        @media (min-width: 600px) { .input-area { padding-bottom: 15px; } }
        
        input { width: 100%; padding: 12px 15px; border-radius: 12px; border: none; background: var(--input); color: var(--text); outline: none; font-size: 16px; }
        .btn-action { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .overlay { position: absolute; inset: 0; background: var(--bg); z-index: 2000; padding: 25px; display: none; flex-direction: column; }
        .overlay.open { display: flex; }
    </style>
</head>
<body>

    <div id="video-grid">
        <video id="local-video" autoplay muted playsinline></video>
        <video id="remote-video" autoplay playsinline></video>
        <div class="call-tools">
            <button class="btn-call-end" onclick="endCall()"><i data-lucide="phone-off"></i></button>
        </div>
    </div>

    <div id="float-ui">
        <div class="btn-float btn-theme" onclick="openOv('ov-theme')"><i data-lucide="palette"></i></div>
        <div class="btn-float btn-notif" onclick="openOv('ov-notif')"><i data-lucide="bell"></i></div>
        <div class="btn-float btn-admin" onclick="openOv('ov-admin')"><i data-lucide="shield-check"></i></div>
    </div>

    <div class="container">
        <div id="ov-admin" class="overlay">
            <h3>Admin Panel</h3><br>
            <div id="adm-login">
                <input type="password" id="admPass" placeholder="Password Admin">
                <button class="btn-action" onclick="loginAdmin()">Verifikasi</button>
            </div>
            <div id="adm-panel" style="display:none;">
                <button class="btn-action" style="background:#059669;" onclick="adminReply()">BALAS CHAT CS</button>
                <input type="text" id="targetRoom" placeholder="Room ID" style="margin-top:20px;">
                <button class="btn-action btn-danger" onclick="adminAction('chat')">Hapus Chat</button>
                <button class="btn-action btn-danger" style="margin-top:40px;" onclick="adminAction('all')">WIPE ALL DATABASE</button>
            </div>
            <button onclick="closeOv()" style="margin-top:auto; background:none; border:none; color:var(--text); opacity:0.5;">Tutup</button>
        </div>

        <div id="ov-theme" class="overlay"><h3>Tema</h3><br><button class="btn-action" onclick="setTheme('dark')">Dark Mode</button><br><button class="btn-action" style="background:#be185d" onclick="setTheme('lembut')">Rose Mode</button><button onclick="closeOv()" style="margin-top:20px;">Tutup</button></div>
        <div id="ov-notif" class="overlay"><h3>Notifikasi</h3><div id="notif-list" style="flex:1; margin-top:20px; opacity:0.5;">Belum ada panggilan baru.</div><button onclick="closeOv()" class="btn-action">Tutup</button></div>

        <div id="login-screen" style="padding:30px; display:flex; flex-direction:column; justify-content:center; height:100%;">
            <h1 style="text-align:center; font-size:4rem; color:var(--primary); font-weight:900; letter-spacing:-4px;">VIP</h1>
            <p style="text-align:center; opacity:0.4; font-size:10px; letter-spacing:5px; margin-bottom:40px;">SECURE CHANNEL</p>
            <input type="text" id="username" placeholder="Username">
            <input type="text" id="roomCode" placeholder="Kode Room">
            <button class="btn-action" onclick="checkRoom()">MASUK <i data-lucide="chevron-right"></i></button>
            <button class="btn-action" style="background:none; color:var(--primary); margin-top:10px; border:1px solid var(--primary);" onclick="contactAdmin()">HUBUNGI ADMIN</button>
        </div>

        <div id="chat-screen" style="display:none; flex-direction:column; height:100%;">
            <header>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div onclick="location.reload()" style="cursor:pointer; color:var(--primary);"><i data-lucide="chevron-left"></i></div>
                    <b id="rtitle">#ROOM</b>
                    <i id="lock-icon" data-lucide="unlock" size="18" onclick="setRoomPass()" style="cursor:pointer; color:var(--primary);"></i>
                </div>
                <div style="display:flex; gap:18px; color:var(--primary);">
                    <i data-lucide="phone" onclick="makeCall(false)" style="cursor:pointer;"></i>
                    <i data-lucide="video" onclick="makeCall(true)" style="cursor:pointer;"></i>
                </div>
            </header>
            <div id="messages"></div>
            <div class="input-area">
                <label style="cursor:pointer; color:var(--primary); display:flex; align-items:center;"><i data-lucide="paperclip"></i><input type="file" accept="image/*" style="display:none;" onchange="handlePap(this)"></label>
                <input type="text" id="msgInp" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="background:none; border:none; color:var(--primary);"><i data-lucide="send"></i></button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const firebaseConfig = { apiKey: "AIzaSyBKugvHq1Y5OeAjUWTAYrvXujJXuhrJKKA", databaseURL: "https://chatsaya-417c0-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myUser, myRoom, peer, localStream, currentCall;

        function openOv(id) { document.getElementById(id).classList.add('open'); }
        function closeOv() { document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open')); }
        function setTheme(t) { document.body.className = t === 'lembut' ? 'theme-lembut' : ''; closeOv(); }

        async function checkRoom() {
            myUser = document.getElementById('username').value.trim();
            myRoom = document.getElementById('roomCode').value.trim().toLowerCase();
            if(!myUser || !myRoom) return;
            const snap = await db.ref(`roomData/${myRoom}`).once('value');
            if(snap.exists() && snap.val().p && prompt("Password:") !== snap.val().p) return alert("Salah!");
            startChat();
        }

        function contactAdmin() {
            myUser = document.getElementById('username').value.trim() || "User";
            myRoom = "admin-support";
            startChat();
        }

        function adminReply() {
            myUser = "OFFICIAL ADMIN"; myRoom = "admin-support";
            closeOv(); startChat();
        }

        function startChat() {
            document.getElementById('float-ui').style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('rtitle').innerText = "#" + myRoom;

            // INIT PEER FOR CALLS
            peer = new Peer(myUser + "-" + myRoom);
            peer.on('open', () => console.log('Peer Ready'));
            
            peer.on('call', async (call) => {
                if(confirm("Panggilan Masuk. Terima?")) {
                    localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                    document.getElementById('video-grid').style.display = 'flex';
                    document.getElementById('local-video').srcObject = localStream;
                    call.answer(localStream);
                    call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
                    currentCall = call;
                }
            });

            db.ref(`rooms/${myRoom}`).on('child_added', s => {
                const d = s.val();
                const div = document.createElement('div');
                div.className = `msg ${d.u === myUser ? 'own' : 'other'} ${d.u === 'OFFICIAL ADMIN' ? 'is-admin' : ''}`;
                div.innerHTML = `<small style="display:block; font-size:9px; font-weight:bold;">${d.u}</small>${d.t || ''}${d.img ? `<img src="${d.img}" style="width:100%; border-radius:10px; margin-top:5px;">` : ''}`;
                document.getElementById('messages').appendChild(div);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            });
        }

        async function makeCall(v) {
            const target = prompt("Masukkan Username teman yang ingin ditelpon:");
            if(!target) return;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: v, audio: true});
                document.getElementById('video-grid').style.display = 'flex';
                document.getElementById('local-video').srcObject = localStream;
                currentCall = peer.call(target + "-" + myRoom, localStream);
                currentCall.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
            } catch (e) { alert("Akses Kamera Ditolak"); }
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-grid').style.display = 'none';
        }

        function sendMsg() {
            const i = document.getElementById('msgInp');
            if(!i.value) return;
            db.ref(`rooms/${myRoom}`).push({ u: myUser, t: i.value });
            i.value = "";
        }

        function handlePap(input) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 500; canvas.width = max; canvas.height = img.height * (max/img.width);
                    canvas.getContext('2d').drawImage(img, 0,0, canvas.width, canvas.height);
                    db.ref(`rooms/${myRoom}`).push({ u: myUser, img: canvas.toDataURL('image/jpeg', 0.6) });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function loginAdmin() {
            if(document.getElementById('admPass').value === "sayaadmin") {
                document.getElementById('adm-login').style.display='none';
                document.getElementById('adm-panel').style.display='block';
            }
        }

        function adminAction(type) {
            const t = document.getElementById('targetRoom').value.toLowerCase();
            if(type === 'all') { if(confirm("Hapus Semua?")) db.ref().remove(); }
            else if(type === 'chat') db.ref(`rooms/${t}`).remove();
            alert("Selesai!");
        }

        async function setRoomPass() {
            const snap = await db.ref(`roomData/${myRoom}/p`).once('value');
            if(snap.exists()) {
                if(prompt("Pass untuk buka:") === snap.val()) db.ref(`roomData/${myRoom}/p`).remove();
            } else {
                const p = prompt("Set Password:");
                if(p) db.ref(`roomData/${myRoom}/p`).set(p);
            }
        }
    </script>
</body>
</html>